<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ChatIQ - AI Chat with Sessions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .chat-bubble-user { background-color: #DBEAFE; color: #1E3A8A; border-radius: 0.75rem; padding: 0.75rem 1rem; max-width: 80%; box-shadow: 0 1px 2px rgba(0,0,0,0.05); word-wrap: break-word; }
        .chat-bubble-bot { background-color: #D1FAE5; color: #065F46; border-radius: 0.75rem; padding: 0.75rem 1rem; max-width: 80%; box-shadow: 0 1px 2px rgba(0,0,0,0.05); word-wrap: break-word; }
        .image-chat-bubble { padding: 0.375rem; border-radius: 0.5rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); max-width: 60%; display: inline-block; }
        .image-chat-bubble img { max-width: 100%; height: auto; border-radius: 0.25rem; object-fit: contain; max-height: 20rem; }
        
        .chat-bubble-bot pre, .chat-bubble-user pre { background-color: #1F2937; color: #F3F4F6; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; margin-top: 0.5rem; margin-bottom: 0.5rem;}
        .chat-bubble-bot code, .chat-bubble-user code { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 0.875em; }

        #chatBox::-webkit-scrollbar, #sessionsList::-webkit-scrollbar { width: 6px; }
        #chatBox::-webkit-scrollbar-track, #sessionsList::-webkit-scrollbar-track { background: #F3F4F6; border-radius: 10px; }
        #chatBox::-webkit-scrollbar-thumb, #sessionsList::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 10px; }
        #chatBox::-webkit-scrollbar-thumb:hover, #sessionsList::-webkit-scrollbar-thumb:hover { background: #9CA3AF; }
        
        .chat-input-bar-container { background-color: #F9FAFB; border-top: 1px solid #E5E7EB; }
        .control-button { padding: 0.625rem; /* 10px */ border-radius: 0.5rem; /* 8px */ display: flex; align-items: center; justify-content: center; transition: background-color 0.2s ease-in-out; }
        .control-button.glassmorphism { background-color: rgba(255, 255, 255, 0.2); backdrop-filter: blur(4px); }
        .control-button.glassmorphism:hover { background-color: rgba(255, 255, 255, 0.3); }
        .control-button svg { width: 1.25rem; height: 1.25rem; color: white; }
        @media (min-width: 640px) { .control-button svg { width: 1.5rem; height: 1.5rem; } }
        
        @keyframes textGradientShiftSubtle { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .animate-text-gradient-subtle { background-size: 250% 250%; animation: textGradientShiftSubtle 8s ease infinite; }
        #voiceInputBtn.recording .mic-icon-path { fill: #ef4444 !important; }

        .session-item { transition: background-color 0.2s ease-in-out; }
        .session-item.active { background-color: #DBEAFE; /* blue-100 */ color: #1E40AF; /* blue-800 */ font-weight: 600;}
        .session-item:hover:not(.active) { background-color: #EFF6FF; /* blue-50 */}
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col h-screen">

    <header class="relative bg-gradient-to-r from-cyan-500 to-indigo-600 text-white py-3 sm:py-4 shadow-lg overflow-hidden z-20">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="text-left">
                <h1 class="text-xl font-black tracking-tight sm:text-2xl lg:text-3xl 
                            text-transparent bg-clip-text bg-gradient-to-br from-pink-400 via-purple-400 to-red-500
                            animate-text-gradient-subtle">ChatIQ</h1>
            </div>
            <div id="authContainer" class="text-right flex items-center space-x-2">
                <button id="newChatBtn" class="hidden bg-green-500 hover:bg-green-600 text-white text-xs sm:text-sm font-semibold py-2 px-3 rounded-lg shadow-md transition duration-150 ease-in-out">New Chat</button>
                <button id="googleSignInBtnHeader" class="bg-white text-indigo-600 hover:bg-indigo-50 text-xs sm:text-sm font-semibold py-2 px-3 sm:px-4 rounded-lg shadow-md transition duration-150 ease-in-out">Sign in with Google</button>
                <div id="userDetailsHeader" class="hidden items-center">
                    <span id="userDisplayNameHeader" class="text-xs sm:text-sm mr-2 sm:mr-3 truncate max-w-[100px] sm:max-w-[150px]"></span>
                    <button id="signOutBtnHeader" class="bg-pink-500 hover:bg-pink-600 text-white text-xs sm:text-sm font-semibold py-2 px-3 rounded-lg shadow-md transition duration-150 ease-in-out">Sign Out</button>
                </div>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside id="chatHistorySidebar" class="w-0 sm:w-64 bg-slate-50 border-r border-slate-200 flex-col p-3 space-y-2 overflow-y-auto transition-all duration-300 ease-in-out hidden"> {/* Initially hidden, shown after sign-in */}
            <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wider px-2">Chat History</h3>
            <div id="sessionsList" class="space-y-1">
                </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden container mx-auto px-0 sm:px-2 py-4">
            <h4 class="text-center text-sm sm:text-base font-semibold
                text-transparent bg-clip-text 
                bg-gradient-to-r from-purple-500 via-pink-500 to-orange-500 
                drop-shadow-md 
                animate-text-gradient-subtle 
                inline-flex items-center justify-center space-x-1 w-full mb-4" id="swipeDownPrompt" style="display: none;">
                <span>Scroll to Discover More</span>
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 sm:w-5 sm:h-5 ml-1 opacity-90">
                   <path fill-rule="evenodd" d="M10 3a.75.75 0 01.75.75v10.69l2.47-2.47a.75.75 0 111.06 1.06l-3.75 3.75a.75.75 0 01-1.06 0L6.22 13.03a.75.75 0 011.06-1.06l2.47 2.47V3.75A.75.75 0 0110 3z" clip-rule="evenodd" />
                 </svg>
            </h4>
            
            <section id="interactiveChatSection" 
                     class="w-full mx-auto 
                            bg-white rounded-xl sm:rounded-2xl shadow-xl overflow-hidden flex flex-col flex-1" 
                     style="display: none;"> 
                <div class="flex-grow overflow-y-auto p-3 sm:p-4 space-y-3" id="chatBoxWrapper"> 
                    <div id="imagePreviewContainer" class="hidden flex flex-col items-center space-y-2 mb-3">
                        <img id="imagePreview" src="#" alt="Image Preview" class="max-w-full h-auto max-h-48 sm:max-h-60 rounded-lg shadow-md border-2 border-gray-200"/>
                        <button id="removeImageBtn" class="text-red-400 hover:text-red-300 text-sm font-medium flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            Remove Image
                        </button>
                    </div>
                    <div id="chatBox" class="space-y-4"> 
                        </div>
                </div>

                <div class="chat-input-bar-container p-2 sm:p-3 border-t border-gray-200">
                    <div id="loadingIndicator" class="hidden text-center pb-2">
                        <div class="flex justify-center items-center"><div class="animate-spin rounded-full h-5 w-5 border-b-2 border-cyan-600"></div><p class="text-cyan-700 ml-2 text-sm">ChatIQ is thinking...</p></div>
                    </div>
                    <div id="errorMessage" class="hidden bg-red-100 text-red-700 p-2 rounded-md text-center mb-2 text-sm"></div>
                    <div class="flex items-center flex-wrap gap-2 sm:gap-3 p-3 bg-gradient-to-r from-cyan-500 to-indigo-600 rounded-xl shadow-lg">
                        <input type="text" id="userInput" placeholder="Ask ChatIQ or describe image..."
                               class="flex-grow min-w-[150px] p-3 rounded-lg text-sm sm:text-base outline-none bg-slate-900/30 text-white placeholder:text-slate-300 focus:ring-2 focus:ring-sky-300 focus:bg-slate-900/40 transition duration-200 ease-in-out backdrop-blur-sm shadow-sm"/>
                        <button id="sendBtn" title="Send Message" class="control-button glassmorphism">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" /></svg>
                        </button>
                        <button id="fileUploadBtn" title="Upload Image" class="control-button glassmorphism">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V4.5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5V15c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9c0 1.66 1.34 3 3 3s3-1.34 3-3V4.5C16 2.01 13.99 0 11.5 0S7 2.01 7 4.5V15c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"></path></svg>
                        </button>
                        <input type="file" id="fileInput" class="hidden" accept="image/*">
                        <button id="cameraBtn" title="Use Camera" class="control-button glassmorphism">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 9a3.75 3.75 0 100 7.5A3.75 3.75 0 0012 9z" /><path fill-rule="evenodd" d="M9.344 3.071a49.52 49.52 0 015.312 0c.967.052 1.83.585 2.332 1.39l.821 1.317c.24.383.645.643 1.11.71.386.054.77.113 1.152.177 1.432.239 2.426 1.458 2.426 2.915V19.5a2.25 2.25 0 01-2.25 2.25H5.25a2.25 2.25 0 01-2.25-2.25V9.525c0-1.456.994-2.676 2.426-2.915.382-.064.766-.123 1.152-.177.465-.067.87-.327 1.11-.71l.82-1.318a2.996 2.996 0 012.332-1.39zM12 6.75a5.25 5.25 0 100 10.5 5.25 5.25 0 000-10.5z" clip-rule="evenodd" /></svg>
                        </button>
                        <button id="voiceInputBtn" title="Voice Input" class="control-button glassmorphism">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="mic-icon">
                                <path class="mic-icon-path" fill-rule="evenodd" d="M12.75 3.006a3.75 3.75 0 013.75 3.75v6.75a3.75 3.75 0 01-7.5 0v-6.75a3.75 3.75 0 013.75-3.75zM8.25 8.254a.75.75 0 000 1.5v.75c0 1.657 1.343 3 3 3s3-1.343 3-3v-.75a.75.75 0 000-1.5h-.75a2.25 2.25 0 01-2.25-2.25v-.75a.75.75 0 00-1.5 0v.75A2.25 2.25 0 019 8.254h-.75zM15 13.5a.75.75 0 001.5 0v-2.628A6.002 6.002 0 006.75 8.25v2.628a.75.75 0 001.5 0V8.25c0-.828.672-1.5 1.5-1.5s1.5.672 1.5 1.5v5.25z" clip-rule="evenodd" fill="currentColor"/>
                                <path class="mic-icon-path" d="M6 10.5a.75.75 0 01.75.75v.75a4.5 4.5 0 009 0V11.25a.75.75 0 011.5 0v.75a6 6 0 01-12 0V11.25A.75.75 0 016 10.5zM12 16.5a.75.75 0 00-.75.75v.75h1.5v-.75a.75.75 0 00-.75-.75z" fill="currentColor"/>
                            </svg>
                        </button>
                    </div>
                    <h6 class="text-slate-500 text-center text-xs mt-3 sm:mt-4">ChatIQ can make mistakes. Please recheck and verify information.</h6>
                </div>
            </section>

            <section class="text-center mt-8" id="alternativeVoiceSection">
                <h2 class="text-2xl font-semibold mb-4">One-to-One Voice Interaction</h2>
                <button onclick="startListeningAdapter()" aria-label="Start Voice Chat with GIF">
                    <img src="https://cdn.dribbble.com/userupload/32122583/file/original-400827bdf243931c8ffd26a268a837ce.gif" alt="Voice Bot Banner" class="mx-auto w-full max-w-md rounded-2xl shadow-lg hover:scale-105 transition-transform"/>
                </button>
                <div class="mt-6">
                    <button onclick="startListeningAdapter()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-md transition text-lg font-medium flex items-center justify-center mx-auto">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="mr-2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3zm7 9a7 7 0 0 1-14 0H3a9 9 0 0 0 8 8.94V22h2v-3.06A9 9 0 0 0 21 10h-2z"></path></svg>
                        Start Voice Chat
                    </button>
                </div>
            </section>
            
            <div id="signInPromptBelowVoiceBot" class="text-center text-gray-600 p-4 mt-2" style="display: block;"> {/* Shown by default, hidden on sign-in */}
                Please <button id="inlineSignInBtn" class="text-indigo-600 hover:text-indigo-800 font-semibold underline">sign in with Google</button> to use all features and save your chat history.
            </div>
            
            <section id="featuresSection" class="mt-8">
               <h2 class="text-2xl font-semibold text-center mb-8">Key Features</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-md hover:shadow-xl transition-shadow text-center">
                        <img src="https://img.freepik.com/premium-vector/ai-chat-bot-technology-concept-people-chatting-with-robot-asking-questions-receiving-answers_36358-1867.jpg" alt="AI Suggestions" class="mx-auto w-36 h-36 object-contain rounded mb-4"/>
                        <h3 class="font-semibold text-lg">AI-Powered Suggestions</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md hover:shadow-xl transition-shadow text-center">
                        <img src="https://i.pinimg.com/originals/7d/9b/1d/7d9b1d662b28cd365b33a01a3d0288e1.gif" alt="Real-Time Voice Chat" class="mx-auto w-36 h-36 object-cover rounded-full mb-4"/>
                        <h3 class="font-semibold text-lg">Real-Time Voice Chat</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md hover:shadow-xl transition-shadow text-center">
                        <img src="https://cdn-icons-png.flaticon.com/512/1048/1048937.png" alt="Image Recognition" class="mx-auto w-36 h-36 object-contain rounded mb-4"/>
                        <h3 class="font-semibold text-lg">Image Vision AI</h3>
                    </div>
                </div>
            </section>

            <section id="feedbackSection" class="text-center mt-8">
                <h2 class="text-2xl font-semibold mb-4">We Value Your Feedback</h2>
                <p class="mb-6 text-gray-600">Help us improve by sharing your thoughts.</p>
                <a href="https://docs.google.com/forms/d/e/1FAIpQLSc2N8OGqdbu2HFbxN4Y89Guv3Wnp9CHLYrz-bzu80kDjHQ3yg/viewform?usp=sharing" target="_blank" class="inline-block bg-gradient-to-r from-indigo-500 to-cyan-400 text-white font-medium px-8 py-3 rounded-full shadow-lg hover:from-indigo-600 hover:to-cyan-500 transition">
                    Give Feedback
                </a>
            </section>
        </main>
    </div>

    <footer class="bg-gradient-to-b from-cyan-500 to-indigo-600 text-white py-10 text-center mt-12">
        <h2 class="text-2xl font-bold mb-4">About ChatIQ</h2>
        <p class="max-w-2xl mx-auto mb-6 px-4">ChatIQ assists by providing accurate, real-time answers to your questions through voice, text, and image interactions.</p>
        <div class="space-y-2"><p>📞 <a href="tel:+919369572534" class="hover:underline">+91 93695 72534</a></p><p>✉️ <a href="mailto:ambuj20maurya@gmail.com" class="hover:underline">ambuj20maurya@gmail.com</a></p><p>📍 Mirzapur, Uttar Pradesh, India</p></div>
        <p class="mt-6 text-sm opacity-90">&copy; 2025 ChatIQ. All rights reserved.</p>
    </footer>
        <div id="cameraModal" class="fixed top-0 left-0 w-full h-full bg-black/60 hidden items-center justify-center z-[1000]">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-md text-center">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Camera Capture</h3>
                <video id="videoPreviewModal" autoplay playsinline class="w-full max-h-[60vh] rounded-lg mb-4 border border-gray-300 bg-gray-100"></video>
                <div class="flex justify-around mt-4">
                    <button id="captureModalBtn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition">Capture</button>
                    <button id="closeCameraModalBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-lg transition">Close</button>
                </div>
            </div>
        </div>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyCEpq8EAkEWbvxGab0wiW9qaYojUdVykyo", // USER PROVIDED
            authDomain: "chatiq-45203.firebaseapp.com",
            databaseURL: "https://chatiq-45203-default-rtdb.firebaseio.com",
            projectId: "chatiq-45203",
            storageBucket: "chatiq-45203.appspot.com",
            messagingSenderId: "642857846726",
            appId: "1:642857846726:web:f95990ff4f4c37971514c7",
            measurementId: "G-R135XXK005"
        };

        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, getDocs, writeBatch, doc, deleteDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"; // Added deleteDoc, updateDoc, getDoc
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

        let app;
        if (!getApps().length) { app = initializeApp(firebaseConfig); } else { app = getApp(); }
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        const appIdForPath = firebaseConfig.appId;

        let chatBox, userInput, sendBtn, fileUploadBtn, fileInput, cameraBtn, voiceInputBtn, imagePreviewContainer, imagePreview, removeImageBtn, loadingIndicator, errorMessageDisplay, googleSignInBtnHeader, userDetailsHeaderDiv, userDisplayNameHeaderSpan, signOutBtnHeader, interactiveChatSection, alternativeVoiceSection, swipeDownPromptElement, newChatBtn, signInPromptBelowVoiceBot, inlineSignInBtn, cameraModal, videoPreviewModal, captureModalBtn, closeCameraModalBtn, sessionsListEl;
        let currentBase64Image = null, currentMimeType = null, mediaStream = null, speechRecognition = null, isRecording = false, currentBotAudio = null, currentUserId = null;
        
        let activeSessionId = null; // To track the current chat session
        let messagesUnsubscribe = null; // For messages of the active session
        let sessionsUnsubscribe = null; // For the list of sessions

        const GOOGLE_API_KEY = "AIzaSyC4RwK4x692XDcHZikOaKfpxWHmIXm4kuM"; // <-- REPLACE!
        const MURF_API_KEY = "ap2_1ed5cd30-2f51-4ebc-b8f6-33c6a31c81e7";   // <-- REPLACE!
        const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GOOGLE_API_KEY}`;
        const botPersonaInstructions = `SYSTEM GUIDELINES: You are a smart ChatIQ bot. Aim for concise and precise responses. For simple questions, keep answers to around 5-6 lines or 50 words. For more complex requests, like recipes or explanations, provide a more detailed answer as needed. You are smart and intelligent and can answer any question asked by the user. Answer in a more humanized form, without bullet points or unnecessary special characters unless the format is essential for clarity (like in a recipe's steps). When a user asks "who are you", respond: 'I am a smart ChatIQ bot.' If the user asks about "your name", respond: 'I am a smart ChatIQ bot.' If the user asks "who made you", respond: 'I was made by ChatIQ.' --- User's request is below. If the user's message specifically asks one of the predefined questions above (who are you, your name, who made you), use ONLY the predefined answer. Otherwise, answer their question following all the general persona guidelines. If an image is provided, consider it in your response along with the text.`;


        function showError(messageText) { 
            console.log("showError called with:", messageText);
            const errorElement = document.getElementById('errorMessage');
            if (errorElement) {
                errorElement.textContent = messageText; errorElement.classList.remove('hidden');
                setTimeout(() => { errorElement.classList.add('hidden'); }, 5000);
            } else { console.error("DOM #errorMessage not found. Early error: " + messageText); alert("Notice: " + messageText); }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Assign all DOM Elements
            chatBox = document.getElementById('chatBox'); userInput = document.getElementById('userInput'); sendBtn = document.getElementById('sendBtn');
            fileUploadBtn = document.getElementById('fileUploadBtn'); fileInput = document.getElementById('fileInput'); cameraBtn = document.getElementById('cameraBtn');
            voiceInputBtn = document.getElementById('voiceInputBtn'); imagePreviewContainer = document.getElementById('imagePreviewContainer');
            imagePreview = document.getElementById('imagePreview'); removeImageBtn = document.getElementById('removeImageBtn');
            loadingIndicator = document.getElementById('loadingIndicator'); errorMessageDisplay = document.getElementById('errorMessage'); 
            googleSignInBtnHeader = document.getElementById('googleSignInBtnHeader');
            userDetailsHeaderDiv = document.getElementById('userDetailsHeader');
            userDisplayNameHeaderSpan = document.getElementById('userDisplayNameHeader');
            signOutBtnHeader = document.getElementById('signOutBtnHeader');
            interactiveChatSection = document.getElementById('interactiveChatSection');
            alternativeVoiceSection = document.getElementById('alternativeVoiceSection');
            swipeDownPromptElement = document.getElementById('swipeDownPrompt');
            newChatBtn = document.getElementById('newChatBtn');
            signInPromptBelowVoiceBot = document.getElementById('signInPromptBelowVoiceBot');
            inlineSignInBtn = document.getElementById('inlineSignInBtn');
            cameraModal = document.getElementById('cameraModal');
            videoPreviewModal = document.getElementById('videoPreviewModal');
            captureModalBtn = document.getElementById('captureModalBtn');
            closeCameraModalBtn = document.getElementById('closeCameraModalBtn');
            sessionsListEl = document.getElementById('sessionsList');

            if(GOOGLE_API_KEY === "YOUR_GEMINI_API_KEY"||MURF_API_KEY === "YOUR_MURF_API_KEY" || GOOGLE_API_KEY.startsWith("AIzaSyC4RwK4x692XDcHZikOaKfpxWHmIXm4ku") || MURF_API_KEY.startsWith("ap2_1ed5cd30-2f51-4ebc-b8f6-33c6a31c81e")){/* Production check might be more robust */}
            
            initializeSpeechRecognition(); 
            setupEventListeners();
            setupAuthListener();
        });
        
        function setupEventListeners() { 
            if(googleSignInBtnHeader) googleSignInBtnHeader.addEventListener('click', signInWithGoogle);
            if(signOutBtnHeader) signOutBtnHeader.addEventListener('click', signOutUser);
            if(newChatBtn) newChatBtn.addEventListener('click', startNewChatSession);
            if(inlineSignInBtn) inlineSignInBtn.addEventListener('click', signInWithGoogle); 

            if(sendBtn) sendBtn.addEventListener('click', handleSendMessageWrapper);
            if(userInput) userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessageWrapper(); }});
            if(fileUploadBtn) fileUploadBtn.addEventListener('click', () => fileInput.click());
            if(fileInput) fileInput.addEventListener('change', handleFileSelect);
            if(removeImageBtn) removeImageBtn.addEventListener('click', removeImagePreview);
            
            if(cameraBtn) cameraBtn.addEventListener('click', openCameraModal); 
            if(captureModalBtn) captureModalBtn.addEventListener('click', captureImageFromModal);
            if(closeCameraModalBtn) closeCameraModalBtn.addEventListener('click', closeCameraModalAndStream);

            if(voiceInputBtn) voiceInputBtn.addEventListener('click', toggleVoiceInput);
        }

        async function signInWithGoogle() { 
            if (!auth) { showError("Firebase Auth not initialized."); return; }
            const provider = new GoogleAuthProvider();
            try { await signInWithPopup(auth, provider); } 
            catch (error) { console.error("Google Sign-In Error:", error); showError(`Google Sign-In Failed: ${error.message} (Code: ${error.code})`); }
        }
        async function signOutUser() { 
            if (!auth) { showError("Firebase Auth not initialized."); return; }
            try { await signOut(auth); activeSessionId = null; if(sessionsListEl) sessionsListEl.innerHTML = ''; } 
            catch (error) { console.error("Sign Out Error:", error); showError("Error signing out: " + error.message); }
        }

        function setupAuthListener() { 
            if (!auth) { console.error("Firebase Auth not initialized for listener."); showError("Critical: Auth service not ready."); return; }
            const chatHistorySidebar = document.getElementById('chatHistorySidebar');
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    if(userDisplayNameHeaderSpan) userDisplayNameHeaderSpan.textContent = `Hi, ${user.displayName || user.email.split('@')[0] || 'User'}!`;
                    if(googleSignInBtnHeader) googleSignInBtnHeader.style.display = 'none';
                    if(newChatBtn) newChatBtn.style.display = 'inline-block'; 
                    if(userDetailsHeaderDiv) userDetailsHeaderDiv.style.display = 'flex';
                    if(interactiveChatSection) interactiveChatSection.style.display = 'flex';
                    if(alternativeVoiceSection) alternativeVoiceSection.style.display = 'none'; 
                    if(signInPromptBelowVoiceBot) signInPromptBelowVoiceBot.style.display = 'none';
                    if(swipeDownPromptElement) swipeDownPromptElement.style.display = 'inline-flex';
                    if(chatHistorySidebar) chatHistorySidebar.classList.remove('hidden'); 
                    if(chatHistorySidebar) chatHistorySidebar.classList.add('flex');

                    loadChatSessions(); 
                } else {
                    currentUserId = null; activeSessionId = null;
                    if(userDisplayNameHeaderSpan) userDisplayNameHeaderSpan.textContent = '';
                    if(googleSignInBtnHeader) googleSignInBtnHeader.style.display = 'inline-block';
                    if(newChatBtn) newChatBtn.style.display = 'none'; 
                    if(userDetailsHeaderDiv) userDetailsHeaderDiv.style.display = 'none';
                    if(interactiveChatSection) interactiveChatSection.style.display = 'none';
                    if(alternativeVoiceSection) alternativeVoiceSection.style.display = 'block';
                    if(signInPromptBelowVoiceBot) signInPromptBelowVoiceBot.style.display = 'block';
                    if(swipeDownPromptElement) swipeDownPromptElement.style.display = 'none';
                    if(chatHistorySidebar) chatHistorySidebar.classList.add('hidden');
                    if(chatHistorySidebar) chatHistorySidebar.classList.remove('flex');

                    if(messagesUnsubscribe) messagesUnsubscribe(); 
                    if(sessionsUnsubscribe) sessionsUnsubscribe();
                    if(chatBox) chatBox.innerHTML = '<div class="text-center text-gray-500 p-4">Please sign in with Google to use ChatIQ and see your history.</div>';
                }
            });
        }
        
        async function startNewChatSession() {
            if (!currentUserId || !db) { showError("Please sign in to start a new chat."); return; }
            console.log("Starting new chat session");
            const newSessionName = `Chat ${new Date().toLocaleString()}`; 
            try {
                const sessionsColPath = `artifacts/${appIdForPath}/users/${currentUserId}/sessions`;
                const sessionRef = await addDoc(collection(db, sessionsColPath), {
                    title: newSessionName,
                    createdAt: serverTimestamp()
                });
                activeSessionId = sessionRef.id;
                console.log("New session created with ID:", activeSessionId);
                if (chatBox) chatBox.innerHTML = ''; 
                // addMessageToChat(`New chat started: ${newSessionName}`, "bot"); // Optional UI message, not saved
                loadChatHistory(activeSessionId); 
            } catch (error) {
                console.error("Error creating new session:", error);
                showError("Could not start a new chat session.");
            }
        }

        async function deleteSession(sessionIdToDelete) {
            if (!currentUserId || !db || !sessionIdToDelete) return;
            console.log(`Attempting to delete session: ${sessionIdToDelete}`);
            const confirmed = confirm("Are you sure you want to delete this chat session and all its messages permanently?");
            if (!confirmed) return;

            try {
                const messagesPath = `artifacts/${appIdForPath}/users/${currentUserId}/sessions/${sessionIdToDelete}/messages`;
                const messagesQuery = query(collection(db, messagesPath));
                const messagesSnapshot = await getDocs(messagesQuery);
                const batch = writeBatch(db);
                messagesSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                console.log(`Messages for session ${sessionIdToDelete} deleted.`);

                const sessionDocPath = `artifacts/${appIdForPath}/users/${currentUserId}/sessions/${sessionIdToDelete}`;
                await deleteDoc(doc(db, sessionDocPath)); 
                console.log(`Session ${sessionIdToDelete} metadata deleted.`);

                if (activeSessionId === sessionIdToDelete) {
                    activeSessionId = null;
                    if (chatBox) chatBox.innerHTML = '<div class="text-center text-gray-500 p-4">Session deleted. Start a new chat or select another.</div>';
                }
            } catch (error) {
                console.error(`Error deleting session ${sessionIdToDelete}:`, error);
                showError("Failed to delete chat session.");
            }
        }

        function loadChatSessions() {
            if (!currentUserId || !db || !sessionsListEl) return;
            if (sessionsUnsubscribe) sessionsUnsubscribe();

            const sessionsColPath = `artifacts/${appIdForPath}/users/${currentUserId}/sessions`;
            const q = query(collection(db, sessionsColPath), orderBy("createdAt", "desc"));

            sessionsUnsubscribe = onSnapshot(q, (snapshot) => {
                sessionsListEl.innerHTML = ''; 
                let firstSessionId = null;
                let sessionCount = 0;
                snapshot.forEach((docSnap) => {
                    sessionCount++;
                    const session = docSnap.data();
                    const sessionId = docSnap.id;
                    if (!firstSessionId) firstSessionId = sessionId; 

                    const item = document.createElement('div');
                    item.dataset.sessionId = sessionId; // Important for selectSession highlighting
                    item.classList.add('session-item', 'p-2', 'rounded-md', 'cursor-pointer', 'text-sm', 'text-slate-700', 'flex', 'justify-between', 'items-center');
                    if (sessionId === activeSessionId) {
                        item.classList.add('active');
                    }
                    
                    const titleSpan = document.createElement('span');
                    titleSpan.textContent = session.title || `Chat from ${session.createdAt?.toDate().toLocaleDateString() || 'Unknown date'}`;
                    titleSpan.classList.add('truncate', 'flex-1', 'mr-2');
                    item.appendChild(titleSpan);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '&times;'; 
                    deleteBtn.classList.add('text-red-400', 'hover:text-red-600', 'font-bold', 'px-1');
                    deleteBtn.title = "Delete this chat session";
                    deleteBtn.onclick = (event) => {
                        event.stopPropagation(); 
                        deleteSession(sessionId);
                    };
                    item.appendChild(deleteBtn);
                    
                    item.onclick = () => selectSession(sessionId);
                    sessionsListEl.appendChild(item);
                });

                if (sessionCount > 0 && !activeSessionId) { 
                    selectSession(firstSessionId);
                } else if (sessionCount === 0 && !activeSessionId) { 
                    startNewChatSession();
                }
            }, (error) => {
                console.error("Error loading chat sessions:", error);
                showError("Could not load chat sessions.");
            });
        }
        
        function selectSession(sessionId) {
            if (activeSessionId === sessionId && chatBox && chatBox.innerHTML !== '<div class="text-center text-gray-400 p-4">Loading chat...</div>') return; 

            console.log("Selecting session:", sessionId);
            activeSessionId = sessionId;
            if (messagesUnsubscribe) messagesUnsubscribe(); 
            if (chatBox) chatBox.innerHTML = '<div class="text-center text-gray-400 p-4">Loading chat...</div>'; 
            loadChatHistory(activeSessionId);

            const sessionItems = sessionsListEl.querySelectorAll('.session-item');
            sessionItems.forEach(item => {
                if (item.dataset.sessionId === sessionId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        async function saveMessageToFirestore(messageData) { 
            if (!currentUserId || !activeSessionId) { showError("Not signed in or no active session. Message not saved."); return; }
            try { 
                const path = `artifacts/${appIdForPath}/users/${currentUserId}/sessions/${activeSessionId}/messages`; 
                await addDoc(collection(db, path), { ...messageData, userId: currentUserId, timestamp: serverTimestamp() }); 
                
                const sessionDocPath = `artifacts/${appIdForPath}/users/${currentUserId}/sessions/${activeSessionId}`;
                const sessionDocRef = doc(db, sessionDocPath);
                const sessionSnap = await getDoc(sessionDocRef); 
                if (sessionSnap.exists()) {
                    const sessionData = sessionSnap.data();
                    let updateData = { lastActivity: serverTimestamp() };
                    // Update title if it's the first user text message and title is default-like
                    if (sessionData.title && (sessionData.title.startsWith("Chat ") || sessionData.title.startsWith("New Chat")) && messageData.sender === 'user' && messageData.type === 'text' && messageData.content) {
                         // Check if this is truly the first *user text* message by querying messages (can be complex)
                         // For simplicity, we'll assume if title is default, this user message can set it.
                         // A more robust way would be to check message count or a 'titleSetByUser' flag in sessionData.
                        const messagesCollectionPath = `artifacts/${appIdForPath}/users/${currentUserId}/sessions/${activeSessionId}/messages`;
                        const messagesQuery = query(collection(db, messagesCollectionPath), orderBy("timestamp", "asc"));
                        const existingMessagesSnap = await getDocs(messagesQuery);
                        let userTextMessages = 0;
                        existingMessagesSnap.forEach(msgDoc => {
                            if (msgDoc.data().sender === 'user' && msgDoc.data().type === 'text') {
                                userTextMessages++;
                            }
                        });

                        if (userTextMessages <= 1) { // If this is the first or only user text message
                           updateData.title = messageData.content.substring(0, 35) + (messageData.content.length > 35 ? '...' : '');
                        }
                    }
                    await updateDoc(sessionDocRef, updateData); 
                }
            } 
            catch (error) { console.error("Error saving to Firestore:", error); showError("Error saving message."); }
        }

        function loadChatHistory(sessionIdToLoad) { 
            if (!db || !chatBox || !sessionIdToLoad) { 
                if(chatBox) chatBox.innerHTML = '<div class="text-center text-gray-500 p-4">Select a chat or start a new one.</div>';
                return; 
            }
            if (messagesUnsubscribe) messagesUnsubscribe(); 
            
            const path = `artifacts/${appIdForPath}/users/${currentUserId}/sessions/${sessionIdToLoad}/messages`;
            const q = query(collection(db, path), orderBy("timestamp", "asc")); 
            
            chatBox.innerHTML = ''; 
            let initialWelcomeAdded = false;

            messagesUnsubscribe = onSnapshot(q, (snapshot) => {
                chatBox.innerHTML = ''; let count = 0;
                snapshot.docChanges().forEach((change) => { // More efficient updates
                    if (change.type === "added") {
                        count++; 
                        const msg = change.doc.data(); 
                        if (msg.type === 'image') addImageToChatLog(msg.content, msg.mimeType, msg.sender); 
                        else addMessageToChat(msg.content, msg.sender); 
                    }
                });
                // If loading all messages (not just changes), use snapshot.forEach directly:
                // snapshot.forEach((doc) => { count++; const msg = doc.data(); ... });
                // For simplicity with initial load and avoiding duplicate welcome messages:
                if (snapshot.empty && !initialWelcomeAdded) { // Check if collection is empty
                     const welcome="Chat started! How can I assist you today?"; 
                     addMessageToChat(welcome, "bot");
                     initialWelcomeAdded = true; 
                } else if (!snapshot.empty) {
                    // If using docChanges, initialWelcomeAdded might need different logic
                    // or ensure that count is based on total docs if not using docChanges for initial render.
                    // The current simple `chatBox.innerHTML = ''; snapshot.forEach(...)` would re-render all,
                    // so the welcome logic would need to be outside the forEach or based on total snapshot size.
                    // Let's revert to simpler full re-render for clarity here, as docChanges can be complex for initial load logic.
                    chatBox.innerHTML = ''; 
                    count = 0;
                     snapshot.forEach((doc) => { 
                         count++;  
                         const msg = doc.data();  
                         if (msg.type === 'image') addImageToChatLog(msg.content, msg.mimeType, msg.sender);  
                         else addMessageToChat(msg.content, msg.sender);  
                     });
                     if (count === 0 && !snapshot.metadata.hasPendingWrites && !initialWelcomeAdded) {  
                         const welcome="Chat started! How can I assist you today?";  
                         addMessageToChat(welcome, "bot");
                         initialWelcomeAdded = true;  
                     }
                }


                if(chatBox) chatBox.scrollTop = chatBox.scrollHeight; 
            }, (error) => { console.error("Error loading messages for session:", sessionIdToLoad, error); showError("Failed to load messages: " + error.message); });
        }
        
        function addMessageToChat(text, sender) { if (!chatBox) return; const messageDiv = document.createElement('div'); messageDiv.classList.add('flex', sender === 'user' ? 'justify-end' : 'justify-start', 'w-full', 'py-1'); const bubbleDiv = document.createElement('div'); bubbleDiv.classList.add(sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot'); const codeBlockRegex = /```(\w*)\n([\s\S]*?)\n```/gm; let lastIndex = 0; let hasCode = false; let contentToAdd = document.createDocumentFragment(); text.replace(codeBlockRegex, (match, lang, codeContent, offset) => { hasCode = true; if (offset > lastIndex) { contentToAdd.appendChild(document.createTextNode(text.substring(lastIndex, offset))); } const preElement = document.createElement('pre'); const codeElement = document.createElement('code'); if (lang) codeElement.classList.add(`language-${lang}`); codeElement.textContent = codeContent.trim(); preElement.appendChild(codeElement); contentToAdd.appendChild(preElement); lastIndex = offset + match.length; return match; }); if (lastIndex < text.length) { contentToAdd.appendChild(document.createTextNode(text.substring(lastIndex))); } if (contentToAdd.hasChildNodes()) { bubbleDiv.appendChild(contentToAdd); } else if (!hasCode) { bubbleDiv.textContent = text; } messageDiv.appendChild(bubbleDiv); chatBox.appendChild(messageDiv); if(chatBox) chatBox.scrollTop = chatBox.scrollHeight; }
        function addImageToChatLog(base64, mime, sender) { if (!chatBox) return; const div = document.createElement('div'); div.classList.add('flex', sender === 'user' ? 'justify-end' : 'justify-start', 'w-full', 'my-1'); const bubble = document.createElement('div'); bubble.classList.add('image-chat-bubble'); bubble.style.backgroundColor = sender === 'user' ? '#DBEAFE' : '#D1FAE5'; const img = document.createElement('img'); img.src = `data:${mime};base64,${base64}`; img.alt = sender === 'user' ? "User image" : "Bot image"; bubble.appendChild(img); div.appendChild(bubble); chatBox.appendChild(div); if(chatBox) chatBox.scrollTop = chatBox.scrollHeight; }
        function showLoading(isLoading) { if(!loadingIndicator) return; loadingIndicator.classList.toggle('hidden', !isLoading); }
        async function handleSendMessageWrapper() { if (!userInput || !chatBox || !currentUserId || !activeSessionId) { showError("Chat not ready. Please sign in and select/start a chat."); return; } await handleSendMessage(); }
        async function handleSendMessage() { 
            const textContent = userInput.value.trim(); const img64 = currentBase64Image; const imgMime = currentMimeType;
            if (!textContent && !img64) { showError("Please type, speak, or upload an image."); return; }
            if (!activeSessionId) { showError("No active chat session. Please start a new chat."); return; }

            if (img64 && imgMime) await saveMessageToFirestore({ sender: 'user', type: 'image', content: img64, mimeType: imgMime });
            if (textContent) await saveMessageToFirestore({ sender: 'user', type: 'text', content: textContent });
            
            if(userInput) userInput.value = ''; removeImagePreview(); showLoading(true);
            if (containsVulgar(textContent)) { const msg = "I cannot assist with that."; addMessageToChat(msg, "bot"); await saveMessageToFirestore({ sender: 'bot', type: 'text', content: msg }); showLoading(false); speakResponse(msg); return; }
            try {
                let parts = []; let prompt = botPersonaInstructions;
                if (textContent) prompt += "\n\nUSER QUERY TEXT: " + textContent; else if (img64 && !textContent) prompt += "\n\nUSER QUERY TEXT: (No text provided, analyze image)";
                parts.push({ text: prompt }); if (img64 && imgMime) parts.push({ inlineData: { mimeType: imgMime, data: img64 } });
                const payload = { contents: [{ role: "user", parts: parts }] };
                const resp = await fetch(geminiApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                let botText = "Sorry, couldn't process that request.";
                if (!resp.ok) { 
                    const errData = await resp.json().catch(()=>({error:{message:"API error with non-JSON response or parsing failed"}})); 
                    botText = `API Error (${resp.status}): ${errData.error?.message || resp.statusText || "Unknown API error"}`; 
                    if (resp.status === 429) botText = "API rate limit exceeded. Please try again later.";
                }
                else { 
                    const res = await resp.json(); 
                    if (res.candidates?.[0]?.content?.parts?.[0]?.text) {
                        botText = res.candidates[0].content.parts[0].text;
                    } else if (res.promptFeedback?.blockReason) {
                        botText = `Blocked: ${res.promptFeedback.blockReason}. Your query might have been flagged as potentially harmful.`;
                    } else if (res.candidates?.[0]?.finishReason && res.candidates[0].finishReason !== "STOP") {
                        botText = `Response generation was stopped due to: ${res.candidates[0].finishReason}. This might be due to safety settings or other limitations.`;
                    }
                }
                // addMessageToChat(botText, 'bot'); // UI update handled by onSnapshot listener
                await saveMessageToFirestore({ sender: 'bot', type: 'text', content: botText }); 
                speakResponse(botText);
            } catch (error) { 
                console.error('API call or processing error:', error); 
                let detailedError = `Error: ${error.message}`;
                if (error.response && error.response.data && error.response.data.error && error.response.data.error.message) {
                     detailedError = `API Error: ${error.response.data.error.message}`;
                }
                showError(detailedError); 
                // addMessageToChat(detailedError, 'bot'); // UI update handled by onSnapshot listener
                await saveMessageToFirestore({ sender: 'bot', type: 'text', content: detailedError });
            } finally { showLoading(false); }
        }
        function initializeSpeechRecognition() { 
            const SR_API = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SR_API) { speechRecognition = new SR_API(); speechRecognition.continuous = false; speechRecognition.lang = 'en-US'; speechRecognition.interimResults = false; speechRecognition.maxAlternatives = 1;
                speechRecognition.onresult = (e) => { const r = e.results[0][0].transcript.trim(); if(userInput)userInput.value=r; stopRecording(); if(r)handleSendMessageWrapper(); else showError("Voice input was empty.");};
                speechRecognition.onerror = (e) => { let m=`Speech recognition error: ${e.error}.`; if(e.error==='no-speech')m="No speech detected. Please try again."; else if(e.error==='audio-capture')m="Microphone error. Please check your microphone."; else if(e.error==='not-allowed')m="Microphone access denied. Please allow microphone access in your browser settings."; else if(e.error==='language-not-supported')m=`The language '${speechRecognition.lang}' is not supported for speech recognition.`; showError(m); stopRecording();};
                speechRecognition.onend = () => { if (isRecording) stopRecording(); };
            } else { if(voiceInputBtn) voiceInputBtn.disabled = true; showError('Speech recognition (voice input) is not supported by your browser.'); }
        }
        async function getMurfAudioUrl(text, lang = 'en-US') { 
            if (!MURF_API_KEY || MURF_API_KEY==="YOUR_MURF_API_KEY" || MURF_API_KEY.startsWith("ap2_1ed5cd30-2f51-4ebc-b8f6-33c6a31c81e") ) { console.warn("Murf API key is a placeholder or invalid."); return null; }
            const cfg={'en-US':{voice:'en-US-ryan',style:'Conversational', mood:'neutral'},'hi-IN':{voice:'hi-IN- Diksha',style:'Conversational', mood:'neutral'}}; // Example voices
            const sel=cfg[lang]||cfg['en-US'];
            const url="https://api.murf.ai/v1/speech/generate"; // V1 endpoint
            const p={text, voice:sel.voice, style:sel.style, mood:sel.mood, format:"mp3", sampleRate: 24000, convertToSsml: true}; // Added mood, sampleRate, convertToSsml
            try { 
                const r=await fetch(url,{method:"POST",headers:{"api-key":MURF_API_KEY,"X-Project-Id": "YOUR_MURF_PROJECT_ID_IF_ANY", "Content-Type":"application/json"},body:JSON.stringify(p)}); // X-Project-Id if needed
                const d=await r.json();
                if(!r.ok){showError(`Murf API Error (${r.status}): ${d.message||'Unknown error'}. Voice attempted: ${sel.voice}`);return null;} 
                if(!d.audioFile){showError(`Murf API Error: No audioFile in response. ${d.message||''}`);return null;} 
                return d.audioFile; // 'audioFile' is the typical key for Murf's V1 response
            } catch(err){showError(`Murf API Exception: ${err.message}.`);return null;}
        }
        async function speakResponse(text) { 
            if(currentBotAudio&&!currentBotAudio.paused)currentBotAudio.pause(); if('speechSynthesis'in window)speechSynthesis.cancel(); let lang='en-US'; if(/[\u0900-\u097F]/.test(text))lang='hi-IN'; let spoken=false;
            const audioUrl=await getMurfAudioUrl(text,lang); if(audioUrl){try{currentBotAudio=new Audio(audioUrl);await currentBotAudio.play();spoken=true;}catch(e){console.error("Murf audio playback error:",e);currentBotAudio=null;}}
            if(!spoken&&'speechSynthesis'in window){const utt=new SpeechSynthesisUtterance(text); utt.lang=lang; 
                try { const voices = speechSynthesis.getVoices(); if(voices.length>0){const v=voices.find(i=>i.lang===lang);if(v)utt.voice=v;} } catch(e) { console.warn("Could not get/set voices for browser TTS", e); }
                speechSynthesis.speak(utt);}else if(!spoken)console.warn('Text-to-speech is not available or Murf API failed.');
        }
        function toggleVoiceInput(){ if(!speechRecognition){showError('Voice input is not available.');return;}if(isRecording)stopRecording();else startRecording();}
        function startRecording() { 
            try { if(userInput)userInput.value=""; if(currentBotAudio&&!currentBotAudio.paused)currentBotAudio.pause(); if('speechSynthesis'in window)speechSynthesis.cancel(); speechRecognition.start();isRecording=true; 
                if(voiceInputBtn) { voiceInputBtn.classList.add('recording'); voiceInputBtn.title="Stop Recording"; }
            }
            catch(e){if(e.name==='InvalidStateError'){/* Already stopping or stopped */ stopRecording(); } else {showError("Voice start error: "+e.message); isRecording=false; 
                if(voiceInputBtn) { voiceInputBtn.classList.remove('recording'); voiceInputBtn.title="Voice Input"; }}
            }
        }
        function stopRecording(){ if(speechRecognition&&isRecording)speechRecognition.stop();isRecording=false; if(voiceInputBtn) { voiceInputBtn.classList.remove('recording'); voiceInputBtn.title="Voice Input";}}
        function handleFileSelect(e){ const f=e.target.files[0];if(f&&f.type.startsWith('image/')){closeCameraModalAndStream();const r=new FileReader();r.onload=(ev)=>{if(imagePreview)imagePreview.src=ev.target.result;currentBase64Image=ev.target.result.split(',')[1];currentMimeType=f.type;if(imagePreviewContainer)imagePreviewContainer.classList.remove('hidden');};r.readAsDataURL(f);}else if(f){showError("Please select an image file (e.g., JPG, PNG, GIF).");if(fileInput)fileInput.value=null;}}
        function removeImagePreview(){ if(imagePreview)imagePreview.src='#';if(imagePreviewContainer)imagePreviewContainer.classList.add('hidden');currentBase64Image=null;currentMimeType=null;if(fileInput)fileInput.value=null;}
        async function openCameraModal() { removeImagePreview(); if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) { try { mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); if(videoPreviewModal) videoPreviewModal.srcObject = mediaStream; if(cameraModal) cameraModal.classList.remove('hidden'); cameraModal.classList.add('flex'); cameraModal.classList.remove('hidden'); } catch (err) { showError("Camera access error: " + err.message + ". Ensure permissions are granted."); } } else { showError("Camera API not supported by your browser."); } }
        function closeCameraModalAndStream() { if (mediaStream) { mediaStream.getTracks().forEach(track => track.stop()); mediaStream = null; } if(videoPreviewModal) videoPreviewModal.srcObject = null; if(cameraModal) {cameraModal.classList.add('hidden'); cameraModal.classList.remove('flex');} }
        function captureImageFromModal() { if (!mediaStream || !videoPreviewModal || !videoPreviewModal.videoWidth) { showError("Camera stream not available or not ready."); return; } const canvas = document.createElement('canvas'); canvas.width = videoPreviewModal.videoWidth; canvas.height = videoPreviewModal.videoHeight; canvas.getContext('2d').drawImage(videoPreviewModal, 0, 0, canvas.width, canvas.height); const dataUrl = canvas.toDataURL('image/png'); if(imagePreview) imagePreview.src = dataUrl; currentBase64Image = dataUrl.split(',')[1]; currentMimeType = 'image/png'; if(imagePreviewContainer) imagePreviewContainer.classList.remove('hidden'); closeCameraModalAndStream(); showError("Image captured! You can now describe it or add text and send."); }
        function containsVulgar(t){if(!t)return false;const V=["examplebadword","anotheroffensive","testvulgar","profanity"];return V.some(b=>t.toLowerCase().includes(b));} // Replace with actual list
        function startListeningAdapter() { 
            const mainChat = document.getElementById('interactiveChatSection');
            const signInBtn = document.getElementById('googleSignInBtnHeader');
            if (mainChat) { 
                if(currentUserId) { mainChat.scrollIntoView({ behavior: 'smooth', block: 'start' }); setTimeout(() => { if (userInput) userInput.focus({preventScroll:true}); toggleVoiceInput(); }, 300); } 
                else { if(signInBtn && signInBtn.style.display !== 'none') { signInBtn.click(); } else { showError("Please sign in with Google first to use voice chat."); } }
            }
        }
        window.startListeningAdapter = startListeningAdapter; // Make it globally accessible for inline HTML onclick

    </script>
</body>
</html>
